<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.afive.wecheck.attendance.AttendanceMapper">

	<select id="getList" resultType="org.afive.wecheck.attendance.AttendanceBean">
		SELECT	*
		FROM attendance;
	</select>

    <select id="get" parameterType="String" resultType="org.afive.wecheck.attendance.AttendanceBean">
    	SELECT	*
    	FROM	attendance
    	WHERE	attendanceID = #{attendanceID};
    </select>
    
    <select id="getIfExists" resultType="org.afive.wecheck.attendance.AttendanceBean">
    	SELECT	*
    	FROM	attendance
    	WHERE	churchServiceID = #{churchServiceID} AND userID = #{userID};
    </select>
    
    <insert id="register" parameterType="org.afive.wecheck.attendance.AttendanceBean" useGeneratedKeys="true" keyProperty="attendanceID">
    	INSERT INTO attendance 
    		(churchServiceID, userID, attendanceTime)
    	VALUES
    		(#{churchServiceID}, #{userID}, #{attendanceTime});
    </insert>
  	  	
  	<select id="checkAttendance" parameterType="hashmap" resultType = "org.afive.wecheck.attendance.AttendanceBean">
  		SELECT	*
  		FROM	attendance
  		WHERE	userID = #{userID}
  		AND		churchServiceID = #{churchServiceID};
  	</select>
  	
  	<select id="getAttendanceList" parameterType="hashmap" resultType = "org.afive.wecheck.attendance.AttendanceResult">
  		SELECT	attendance.attendanceID,
  				churchService.churchServiceID,
  				churchService.state as churchServiceState,
  				DATE_FORMAT(churchService.startTime,'%Y-%m-%d %H:%i:%s') as startTime,
  				region.regionName,
  				unit.unitName
		FROM	churchService
		INNER JOIN region ON churchService.regionID = region.regionID
		INNER JOIN unit ON churchService.unitID = unit.unitID
		INNER JOIN user ON churchService.regionID = user.regionID
			AND churchService.unitID = user.unitID 
			AND user.userID = #{userID}
			AND now() &gt; churchService.endTime
			AND churchService.churchServiceID &lt; #{lastItemID}
		LEFT JOIN attendance ON attendance.churchServiceID = churchService.churchServiceID
			AND attendance.userID = #{userID}
			order by startTime desc
			limit #{size}
			;
			
  	</select>

</mapper>
